from snakemake.utils import min_version
from pathlib import Path

##### set minimum snakemake version #####
min_version("8.4.1")


configfile: "config/config.yaml"

# Set the destination directory
destination_dir = "/scratch/giulia.pontali/pQTL_bonferroni_significant"

# Function to get sequence numbers from subdirectories
def get_seq_numbers(wildcards):
    import os
    source_dir = "/exchange/healthds/pQTL/results/META_CHRIS_INTERVAL/qced_sumstats_digits/output"
    seq_numbers = []
    for subdir in os.listdir(source_dir):
        if subdir.startswith("seq") and os.path.isdir(os.path.join(source_dir, subdir)):
            seq_number = subdir.lstrip("seq")
            seq_numbers.append(seq_number)
    return seq_numbers

rule all:
    input:
        expand(f"{destination_dir}/seq{{seq_number}}.txt", seq_number=get_seq_numbers)

rule process_files:
    input:
        lambda wildcards: expand("/exchange/healthds/pQTL/results/META_CHRIS_INTERVAL/qced_sumstats_digits/output/seq{seq_number}/*.gwaslab.tsv.gz", seq_number=wildcards.seq_number)
    output:
        f"{destination_dir}/seq{{seq_number}}.txt"
    shell:
        """
        seq_number={wildcards.seq_number}
        dest_filename={output}
        threshold=$(awk 'BEGIN{{print 10.90069}}')

        for file in {input}; do
            if [ -e "$file" ]; then
                zcat "$file" | awk -v threshold=$threshold 'BEGIN{{OFS="\t"}} $13 > threshold {{print}}' > temp_file.txt

                if [ $(wc -l < temp_file.txt) -gt 1 ]; then
                    mv temp_file.txt $dest_filename
                else
                    rm temp_file.txt
                fi
            fi
        done
        """
